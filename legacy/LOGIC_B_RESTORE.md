# ロジックB復元手順

## 概要
ロジックB: AI転職エージェント音声ボット（面談日程調整機能）
- **状態**: テスト保留中
- **タグ**: `logic-b`
- **最終更新**: 2025-12-12

---

## ロジックBに戻す方法

### 1. Gitでロジックbにチェックアウト
```bash
cd c:\Users\se_pi\Desktop\TTS
git checkout logic-b
```

### 2. Railwayにデプロイ
```bash
git push -f origin main
```

### 3. テスト実施

---

## ロジックBの機能

### 実装済み機能
1. **日付計算ツール (`calculate_date`)**
   - 「明日」「来週」などの相対的な日付を正確な日付（YYYY-MM-DD）に変換
   
2. **スケジュール確認 (`check_availability`)**
   - 土日（土曜・日曜）は自動的にNG
   - 曜日名を含めた明確なメッセージ
   
3. **予約保存 (`save_appointment`)**
   - 面談日時と伝言を `appointments.json` に保存
   
4. **再架電予約 (`save_callback`)**
   - 時間がない場合の再架電リクエストを `callbacks.json` に保存
   
5. **伝言の復唱と複数回確認**
   - 伝言を復唱して確認
   - 「他に伝えたい事項はございますか」を複数回聞く
   
6. **曖昧な時間の具体化**
   - 「夕方」「午後」などは具体的な時間を聞き返す

### データ確認エンドポイント
- `/appointments` - 予約データ確認
- `/callbacks` - 再架電リクエスト確認

---

## 未解決の問題（テスト保留理由）

### 🔴 Critical Issues
1. **日付計算が機能しない**
   - 「明日」と言っても `calculate_date` ツールが呼ばれない
   - AIが自分で日付を計算してしまう（誤った日付になる）
   
2. **土日チェックが機能しない**
   - 土曜日・日曜日の予約を受け付けてしまう
   - check_availabilityで土日を検出しているはずだが、AIが無視している

### 実施した修正（未テスト）
- システムメッセージに「絶対に自分で計算せず、必ず calculate_date ツールを使ってください」を3箇所追加
- 「土日は絶対に提案しないでください」を追加
- check_availabilityにデバッグログ追加

---

## テストすべき項目

### テストケース1: 日付計算 🔴 Critical
1. 「明日でお願いします」と言う
2. **期待**: ログに `[INFO] Calculating date for: 明日` が表示される
3. **期待**: AIが「12月13日（金曜日）ですね」と正しく復唱する
4. **以前の問題**: 「12月12日」（今日）や「12月15日」（勝手に変換）と誤認識

### テストケース2: 土日チェック 🔴 Critical
1. 「12月14日でお願いします」と言う（土曜日）
2. **期待**: ログに `[DEBUG] Date: 2025-12-14, Weekday: 5, Day name: 土` が表示
3. **期待**: ログに `[INFO] Weekend detected: 2025-12-14 is 土` が表示
4. **期待**: AIが「12月14日（土曜日）は担当者がお休みをいただいております。平日でご都合の良い日はございますか。」と返答
5. **以前の問題**: 土日の予約を受け付けてしまう

### テストケース3: 伝言の復唱 🟡 Important
1. 日程決定後、「履歴書の添削をお願いしたいです」と言う
2. **期待**: 「履歴書の添削をお願いしたい、とお伝えいたします。お間違いないでしょうか」と復唱

### テストケース4: 複数の伝言 🟡 Important
1. 伝言1を伝える → 復唱
2. 「他に伝えたい事項はございますか」と聞かれる
3. 伝言2を伝える → 再度復唱
4. 再度「他に伝えたい事項はございますか」と聞かれる

### テストケース5: 曖昧な時間の具体化 🟡 Important
1. 「夕方でお願いします」と言う
2. **期待**: 「夕方でしたら、何時頃がよろしいでしょうか」と聞き返す
3. 「17時で」と答える
4. **期待**: 「12月XX日（X曜日）17時でお間違いないでしょうか」と確認

### テストケース6: 時間がない場合の再架電 🟠 Medium
1. 最初の「3分ほどお時間よろしいでしょうか」に「今は難しいです」と答える
2. **期待**: 「承知いたしました。それでは改めてご連絡させていただきたいのですが、いつ頃でしたらお時間よろしいでしょうか。」
3. 「明日の17時なら」と答える
4. **期待**: calculate_dateで日付計算 → save_callbackで保存 → 「それでは、12月13日17時頃に改めてご連絡させていただきます。失礼いたします。」→ 切断

### テストケース7: 通話終了 🟠 Medium
1. すべて完了後、AIが最後の挨拶をする
2. **期待**: 「本日はお忙しい中お時間をいただき、ありがとうございました。当日よろしくお願いいたします。失礼いたします。」
3. **期待**: 「失礼いたします」まで言い終わってから数秒以内に切断

### テストケース8: データ確認 🟠 Medium
1. ブラウザで `https://your-railway-url/appointments` にアクセス
2. **期待**: 予約データがJSON形式で表示される

---

## 技術詳細

### システムメッセージの主要部分
```
【重要な注意事項】
・「明日」「来週」「明後日」「X日後」などの相対的な日付は、絶対に自分で計算せず、必ず calculate_date ツールを使ってください
・土日（土曜日、日曜日）は絶対に提案しないでください。担当者は土日休みです

【会話の流れ】
3. 日付の処理：
   - 相対的な表現（明日、来週、明後日など）→ 【重要】絶対に自分で計算せず、必ず calculate_date ツールを呼び出す
   - calculate_dateの結果を復唱確認
   - check_availability で担当者のスケジュールを確認（土日は自動的にNGが返る）
```

### ツール一覧
1. `calculate_date` - 相対日付を変換
2. `check_availability` - スケジュール確認（土日チェック含む）
3. `save_appointment` - 予約保存
4. `save_callback` - 再架電予約
5. `end_call` - 通話終了

---

## 次のステップ（ロジックBに戻したとき）

1. Railwayのデプロイ完了を待つ
2. 上記のテストケースを順番に実施
3. ログを確認して問題を特定
4. 必要に応じて追加修正
5. すべて正常なら「ロジックB完成」としてタグ付け

---

## 備考
- ファイル保存は `appointments.json` と `callbacks.json`（エフェメラル、再デプロイで消える）
- 永続化が必要な場合はデータベースへの移行を検討
- 現在の日時: 2025-12-12（木）
